# 设备状态监控 - WebSocket实现方案

## 概述

本方案通过在FastAPI后端实现WebSocket功能，解决了前端轮询查询设备状态的问题。即使TDengine数据库只支持RESTful接口，我们仍然可以通过WebSocket实现实时推送设备状态，提高系统性能和用户体验。

## 实现原理

1. **前端**：通过WebSocket连接到FastAPI服务器，订阅特定设备的状态更新
2. **后端**：FastAPI服务器通过RESTful接口定期查询TDengine数据库，获取设备状态
3. **状态推送**：只有当设备状态发生变化时，才通过WebSocket向前端推送状态更新

## 文件结构

```
fastapi-backend/
├── app/
│   ├── api/
│   │   ├── websocket.py          # WebSocket路由和实现
│   │   └── equ_monitor.py        # 原有设备监控接口（已优化）
│   ├── main.py                   # 主应用文件（已更新）
│   └── ...
└── websocket_example.html       # 前端WebSocket示例页面
```

## 主要改进

### 1. 性能优化

- **减少数据库查询**：只在状态变化时才推送数据，避免不必要的查询
- **连接管理**：实现了WebSocket连接管理器，支持多设备监控
- **状态缓存**：在服务器端缓存设备状态，避免重复查询

### 2. 代码优化

- **错误处理修复**：修复了原有接口中错误处理的问题
- **SQL注入防护**：使用参数化查询防止SQL注入攻击
- **资源管理**：确保数据库连接正确关闭，避免资源泄漏

### 3. 实时性提升

- **即时推送**：状态变化后立即推送给前端，无需等待轮询间隔
- **心跳检测**：实现了WebSocket心跳机制，确保连接稳定性
- **自动重连**：连接断开后自动尝试重新连接

## 使用方法

### 1. 启动后端服务

```bash
cd fastapi-backend
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 前端连接WebSocket

前端可以通过以下URL连接到WebSocket：

```
ws://127.0.0.1:8000/api/ws/equipment/{设备名称}
```

例如，监控01#卷烟机：

```javascript
const websocket = new WebSocket('ws://127.0.0.1:8000/api/ws/equipment/01#卷烟机');
```

### 3. 消息格式

#### 服务器推送的消息格式

```json
{
  "equipment_name": "01#卷烟机",
  "status": "运行",
  "timestamp": "2023-08-15T10:30:45.123456"
}
```

#### 客户端发送的消息格式

**心跳检测**：
```json
{
  "type": "ping"
}
```

**获取当前状态**：
```json
{
  "type": "get_status"
}
```

### 4. 示例页面

打开 `websocket_example.html` 文件，选择设备后即可看到实时状态更新。

## 与轮询方式的对比

| 特性 | 轮询方式 | WebSocket方式 |
|------|---------|---------------|
| 实时性 | 低，最多延迟2秒 | 高，状态变化立即推送 |
| 服务器负载 | 高，固定频率查询 | 低，只在状态变化时查询 |
| 网络流量 | 高，定期发送请求 | 低，只在状态变化时发送数据 |
| 用户体验 | 一般，有延迟 | 优，实时更新 |
| 实现复杂度 | 简单 | 较复杂，需要管理连接 |

## 扩展建议

1. **认证与授权**：添加WebSocket连接的认证机制，确保只有授权用户可以连接
2. **消息队列**：对于大规模部署，可以考虑使用消息队列（如Redis Pub/Sub）来管理状态更新
3. **负载均衡**：在多服务器环境下，需要考虑WebSocket连接的负载均衡和会话保持
4. **数据压缩**：对于复杂的状态数据，可以考虑使用压缩算法减少网络传输量
5. **历史数据查询**：保留原有的RESTful接口，用于查询历史数据和统计分析

## 注意事项

1. **WebSocket连接数限制**：每个WebSocket连接都会占用服务器资源，需要合理设置最大连接数
2. **连接稳定性**：网络不稳定时，需要实现自动重连机制
3. **跨域问题**：确保前端和后端的CORS配置正确，允许WebSocket连接
4. **错误处理**：完善错误处理机制，确保系统稳定运行

## 总结

通过WebSocket实现设备状态实时监控，相比轮询方式具有显著优势：
- 提高系统性能，减少不必要的数据库查询
- 提升用户体验，实现实时状态更新
- 降低网络流量，减少不必要的请求
- 提高系统可扩展性，支持更多设备监控

这种实现方式既保留了原有TDengine数据库的RESTful接口，又通过WebSocket实现了实时推送，是一种理想的解决方案。